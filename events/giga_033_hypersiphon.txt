namespace = giga_hypersiphon

# tracker situation attached to hypersiphon mega starts the instability situation for owning player if they have instability gain
situation_event = {
    id = giga_hypersiphon.001
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        target = {
            exists = owner
            owner = {
                giga_is_playable_country = yes
                not = {
                    country_has_situation = {
                        SITUATION = giga_situation_hypersiphon_instability
                    }
                }
                check_modifier_value = {
                    modifier = giga_shroud_conduit_instability
                    value > 0
                }
            }
        }
    }

    immediate = {
        target.owner = {
            start_situation = {
                type = giga_situation_hypersiphon_instability
            }
        }
    }
}

# instability intro event
country_event = {
    id = giga_hypersiphon.002
    title = giga_hypersiphon.002.name
    desc = giga_hypersiphon.002.desc
    picture = GFX_evt_shroudwalker_enclave
    show_sound = event_psionic
    is_triggered_only = yes

    trigger = {
        not = { has_country_flag = hypersiphon_instability_intro }
    }

    immediate = {
        set_country_flag = hypersiphon_instability_intro
    }

    option = {
        name = giga_hypersiphon.002.a

        tooltip = {
            start_situation = {
                type = giga_situation_hypersiphon_instability
            }
        }
    }
}

# instability random event gateway
situation_event = {
    id = giga_hypersiphon.003
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        random_list = {
            0 = {
                modifier = {
                    current_stage = giga_situation_hypersiphon_instability_stage_1
                    add = 96 # every 8 years
                }
                modifier = {
                    current_stage = giga_situation_hypersiphon_instability_stage_2
                    add = 72 # every 6 years
                }
                modifier = {
                    current_stage = giga_situation_hypersiphon_instability_stage_3
                    add = 48 # every 4 years
                }
                modifier = {
                    current_stage = giga_situation_hypersiphon_instability_stage_4
                    add = 24 # every 2 years
                }
                modifier = {
                    current_stage = giga_situation_hypersiphon_instability_stage_5
                    add = 12 # every year
                }

                # mitigation
                modifier = {
                    current_situation_approach = giga_situation_hypersiphon_instability_approach_mitigate
                    multiply = 2 # twice as likely to be nothing when mitigating
                }
            }
            1 = {
                # random bad effect
                situation_event = {
                    id = giga_hypersiphon.004
                    random = 29
                }
            }
        }
    }
}

# bad effect gateway
situation_event = {
    id = giga_hypersiphon.004
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        not = {
            has_situation_flag = random_event_cooldown
        }
    }

    immediate = {
        set_timed_situation_flag = {
            flag = random_event_cooldown
            days = 75
        }
        random_list = {
            100 = {
                # sludge and other planet issues
                situation_event = {
                    id = giga_hypersiphon.010
                }
            }
            50 = {
                # shroud cows
                modifier = {
                    current_stage = giga_situation_hypersiphon_instability_stage_1
                    multiply = 2 # more common in stage 1
                }

                situation_event = {
                    id = giga_hypersiphon.020
                }
            }
            100 = {
                # visions of doom and other pop problems
                modifier = {
                    current_stage >= giga_situation_hypersiphon_instability_stage_4
                    multiply = 2 # more common stage 4+
                }

                situation_event = {
                    id = giga_hypersiphon.030
                }
            }
            10 = {
                # minor incursion
                modifier = {
                    current_stage >= giga_situation_hypersiphon_instability_stage_2
                    multiply = 2
                }
                modifier = {
                    current_stage >= giga_situation_hypersiphon_instability_stage_3
                    multiply = 2
                }
                modifier = {
                    current_stage >= giga_situation_hypersiphon_instability_stage_4
                    multiply = 4
                }
                modifier = {
                    current_stage >= giga_situation_hypersiphon_instability_stage_5
                    multiply = 2 # gets more likely with later stages
                }


            }
        }
    }
}

########################################################################################################################
# a series of unfortunate events (random bad things)

########################################################################################################################
# random planet gets nasty blocker
situation_event = {
    id = giga_hypersiphon.010
    title = giga_hypersiphon.010.name
    desc = giga_hypersiphon.010.desc
    picture = GFX_evt_shrouded_planet
    show_sound = event_psionic
    is_triggered_only = yes
    situation = this
    location = event_target:hypersiphon_target

    immediate = {
        # pick a target planet
        owner = {
            random_owned_planet = {
                weights = {
                    base = 1
                    modifier = {
                        has_planet_flag = hypersipon_instability_effect
                        multiply = 0.01
                    }
                    modifier = {
                        not = {
                            has_active_building = building_giga_shroud_conduit
                        }
                        multiply = 0.01
                    }
                }

                save_event_target_as = hypersiphon_target
                set_timed_planet_flag = {
                    flag = hypersipon_instability_effect
                    years = 10
                }

                random_list = {
                    1 = {
                        set_planet_flag = hypersiphon_instability_1_1
                    }
                    1 = {
                        set_planet_flag = hypersiphon_instability_1_2
                    }
                    1 = {
                        set_planet_flag = hypersiphon_instability_1_3
                    }
                    1 = {
                        modifier = {
                            root = { current_stage >= giga_situation_hypersiphon_instability_stage_3 }
                            multiply = 1.5
                        }
                        set_planet_flag = hypersiphon_instability_1_4
                    }
                    1 = {
                        modifier = {
                            root = { current_stage >= giga_situation_hypersiphon_instability_stage_3 }
                            multiply = 1.5
                        }
                        modifier = {
                            root = { current_stage >= giga_situation_hypersiphon_instability_stage_4 }
                            multiply = 3
                        }
                        set_planet_flag = hypersiphon_instability_1_5
                    }
                }
            }
        }
    }

    option = {
        name = giga_hypersiphon.010.a

        event_target:hypersiphon_target = {
            switch = {
                trigger = has_planet_flag
                hypersiphon_instability_1_1 = {
                    custom_tooltip = giga_hypersiphon.010.result.1
                    add_planet_devastation = 20
                    add_deposit = d_giga_hypersiphon_goop
                    remove_planet_flag = hypersiphon_instability_1_1
                }
                hypersiphon_instability_1_2 = {
                    custom_tooltip = giga_hypersiphon.010.result.2
                    add_planet_devastation = 20
                    add_deposit = d_giga_hypersiphon_goop
                    add_deposit = d_giga_hypersiphon_goop
                    remove_planet_flag = hypersiphon_instability_1_2
                }
                hypersiphon_instability_1_3 = {
                    custom_tooltip = giga_hypersiphon.010.result.3
                    add_planet_devastation = 25
                    add_deposit = d_giga_hypersiphon_goop
                    add_deposit = d_giga_hypersiphon_psionic_anomaly
                    remove_planet_flag = hypersiphon_instability_1_3
                }
                hypersiphon_instability_1_4 = {
                    custom_tooltip = giga_hypersiphon.010.result.4
                    add_planet_devastation = 30
                    add_deposit = d_giga_hypersiphon_goop
                    add_deposit = d_giga_hypersiphon_goop
                    add_deposit = d_giga_hypersiphon_psionic_anomaly
                    remove_planet_flag = hypersiphon_instability_1_4
                }
                hypersiphon_instability_1_5 = {
                    custom_tooltip = giga_hypersiphon.010.result.5
                    add_planet_devastation = 60
                    add_deposit = d_giga_hypersiphon_goop
                    add_deposit = d_giga_hypersiphon_goop
                    add_deposit = d_giga_hypersiphon_psionic_anomaly
                    if = { limit = { is_artificial = yes}
                        add_deposit = d_giga_hypersiphon_psionic_supercell_artificial
                    }
                    else = {
                        add_deposit = d_giga_hypersiphon_psionic_supercell_planet
                    }
                    remove_planet_flag = hypersiphon_instability_1_5
                }
            }
        }
    }
}

########################################################################################################################
# random system gets a space debuff and shroud cows
situation_event = {
    id = giga_hypersiphon.020
    title = giga_hypersiphon.020.name
    desc = {
        trigger = {
            not = { owner = { has_country_flag = hypersiphon_instability_cows_seen } }
        }
        text = giga_hypersiphon.020.desc.first
    }
    desc = {
        trigger = {
            owner = {
                has_country_flag = hypersiphon_instability_cows_seen
                not = { has_country_flag = hypersiphon_instability_cows_damage }
            }
        }
        text = giga_hypersiphon.020.desc.normal
    }
    desc = {
        trigger = {
            owner = {
                has_country_flag = hypersiphon_instability_cows_seen
                has_country_flag = hypersiphon_instability_cows_damage
            }
        }
        text = giga_hypersiphon.020.desc.damage
    }
    picture = {
        picture = GFX_evt_tiyanki_observation
        trigger = { owner = { not = { has_country_flag = hypersiphon_instability_cows_damage } } }
    }
    picture = {
        picture = GFX_evt_exploding_ship
        trigger = { owner = { has_country_flag = hypersiphon_instability_cows_damage } }
    }
    show_sound = event_psionic
    is_triggered_only = yes
    situation = this
    location = event_target:hypersiphon_target

    immediate = {
        owner = {
            if = {
                limit = {
                    any_system_within_border = {
                        not = {
                            has_star_flag = hypersiphon_instability_effect
                        }
                    }
                }

                random_system_within_border = {
                    limit = {
                        not = {
                            has_star_flag = hypersiphon_instability_effect
                        }
                    }

                    weights = {
                        base = 1
                        modifier = {
                            is_bottleneck_system = yes
                            multiply = 10
                        }
                    }

                    save_event_target_as = hypersiphon_target
                    set_star_flag = hypersiphon_instability_effect

                    random_list = {
                        10 = {
                            # slow, shield weakening
                            add_modifier = {
                                modifier = giga_hypersiphon_storm_1
                            }
                            create_ambient_object = {
                                type = giga_hypersiphon_storm_1
                                location = star
                                effect = {
                                    set_ambient_object_flag = hypersiphon_cows
                                    set_location = {
                                        target = prev
                                        distance = 0
                                        angle = random
                                    }
                                }
                            }
                            # spawn cows
                            while = {
                                count = 3
                                random_system_planet = {
                                    giga_spawn_shroud_cows = yes
                                }
                            }
                        }
                        10 = {
                            # armour weakened, hull weakened
                            add_modifier = {
                                modifier = giga_hypersiphon_storm_2
                            }
                            create_ambient_object = {
                                type = giga_hypersiphon_storm_2
                                location = star
                                effect = {
                                    set_ambient_object_flag = hypersiphon_cows
                                    set_location = {
                                        target = prev
                                        distance = 0
                                        angle = random
                                    }
                                }
                            }
                            # spawn cows
                            while = {
                                count = 5
                                random_system_planet = {
                                    giga_spawn_shroud_cows = yes
                                }
                            }
                        }
                        10 = {
                            modifier = {
                                root = { current_stage >= giga_situation_hypersiphon_instability_stage_4}
                                multiply = 2
                            }

                            # slow, shield AND armour weakened
                            add_modifier = {
                                modifier = giga_hypersiphon_storm_3
                            }
                            create_ambient_object = {
                                type = giga_hypersiphon_storm_3
                                location = star
                                effect = {
                                    set_ambient_object_flag = hypersiphon_cows
                                    set_location = {
                                        target = prev
                                        distance = 0
                                        angle = random
                                    }
                                }
                            }
                            # spawn cows
                            while = {
                                count = 7
                                random_system_planet = {
                                    giga_spawn_shroud_cows = yes
                                }
                            }
                        }
                        1 = {
                            modifier = {
                                root = { current_stage >= giga_situation_hypersiphon_instability_stage_4}
                                multiply = 10
                            }
                            modifier = {
                                root = { current_stage >= giga_situation_hypersiphon_instability_stage_5}
                                multiply = 5
                            }

                            # slowed, shield, armour and hull weakened, DEGEN
                            add_modifier = {
                                modifier = giga_hypersiphon_storm_4
                            }
                            create_ambient_object = {
                                type = giga_hypersiphon_storm_4
                                location = star
                                effect = {
                                    set_ambient_object_flag = hypersiphon_cows
                                    set_location = {
                                        target = prev
                                        distance = 0
                                        angle = random
                                    }
                                }
                            }
                            # spawn cows
                            while = {
                                count = 9
                                random_system_planet = {
                                    giga_spawn_shroud_cows = yes
                                }
                            }
                        }
                    }
                    # clean out the storm spawned here
                    system_event = {
                        id = giga_hypersiphon.021
                        days = 1000
                        random = 800
                    }
                }
            }
            else = {
                random_system_within_border = {
                    save_event_target_as = hypersiphon_target

                    # spawn cows
                    while = {
                        count = 3
                        random_system_planet = {
                            giga_spawn_shroud_cows = yes
                        }
                    }

                    # damage every colony in the system
                    every_system_colony = {
                        add_planet_devastation = 50
                    }

                    # damage every station in the system
                    every_orbital_station = {
                        every_owned_ship = {
                            limit = { not = { is_ship_class = shipclass_starbase } }
                            random_list = {
                                1 = { reduce_hp = 500 }
                                1 = { reduce_hp = 5000 }
                                1 = { reduce_hp = 20000 }
                                1 = { reduce_hp = 50000 }
                            }
                        }
                    }
                }
                set_country_flag = hypersiphon_instability_cows_damage
            }

            # instant communications - everyone else gets it at month turnover
            giga_establish_shroud_cow_communications = yes
        }
    }

    # first encounter
    option = {
        name = giga_hypersiphon.020.a

        trigger = {
            not = { owner = { has_country_flag = hypersiphon_instability_cows_seen } }
        }
    }

    # neutral followups
    option = {
        name = giga_hypersiphon.020.b

        trigger = {
            owner = {
                has_country_flag = hypersiphon_instability_cows_seen
                not = { is_hostile = event_target:giga_shroud_cow_country }
            }
        }
    }

    # hostile
    option = {
        name = giga_hypersiphon.020.c

        trigger = {
            owner = {
                has_country_flag = hypersiphon_instability_cows_seen
                is_hostile = event_target:giga_shroud_cow_country
            }
        }
    }

    # make sure they're known for next time
    after = {
        custom_tooltip = giga_hypersiphon.020.effect

        hidden_effect = {
            owner = {
                set_country_flag = hypersiphon_instability_cows_seen
     remove_country_flag = hypersiphon_instability_cows_damage # clear description flag if present
            }
        }
    }
}

# shroud cows get cleaned out on timer
system_event = {
    id = giga_hypersiphon.021
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        remove_star_flag = hypersiphon_instability_effect

        # remove modifiers
        switch = {
            trigger = has_modifier
            giga_hypersiphon_storm_1 = { remove_modifier = giga_hypersiphon_storm_1 }
            giga_hypersiphon_storm_2 = { remove_modifier = giga_hypersiphon_storm_2 }
            giga_hypersiphon_storm_3 = { remove_modifier = giga_hypersiphon_storm_3 }
            giga_hypersiphon_storm_4 = { remove_modifier = giga_hypersiphon_storm_4 }
        }

        # remove storm effects
        every_system_ambient_object = {
            limit = {
                has_ambient_object_flag = hypersiphon_cows
            }
            destroy_ambient_object = this
        }

        # remove cows
        every_fleet_in_system = {
            limit = {
                has_fleet_flag = hypersiphon_cows
            }
            delete_fleet = this
        }

        # notify system owner
        if = {
            limit = {
                exists = space_owner
            }
            space_owner = {
                country_event = {
                    id = giga_hypersiphon.022
                }
            }
        }
    }
}

# shroud cow clean out notification
country_event = {
    id = giga_hypersiphon.022
    title = giga_hypersiphon.022.name
    desc = giga_hypersiphon.022.desc
    picture = GFX_evt_surreal_visions
    show_sound = event_psionic
    location = from.star
    is_triggered_only = yes

    option = {
        name = giga_hypersiphon.022.a
    }
}

########################################################################################################################
# visions of doom (planet modifiers, pop modifiers, deaths)

@debuff_days = 1080
situation_event = {
    id = giga_hypersiphon.030
    title = giga_hypersiphon.030.name
    desc = giga_hypersiphon.030.desc
    picture = GFX_evt_ongoing_disaster
    show_sound = event_psionic
    is_triggered_only = yes
    situation = this
    location = event_target:hypersiphon_target

    immediate = {
        # pick a target planet
        owner = {
            random_owned_planet = {
                weights = {
                    base = 1
                    modifier = {
                        has_planet_flag = hypersipon_instability_effect
                        multiply = 0.01
                    }
                    modifier = {
                        not = {
                            has_active_building = building_giga_shroud_conduit
                        }
                        multiply = 0.01
                    }
                }

                save_event_target_as = hypersiphon_target
                set_timed_planet_flag = {
                    flag = hypersipon_instability_effect
                    years = 10
                }

                # roll 1: killing pops and devastation
                random_list = {
                    30 = {
                        # no pops die
                        set_planet_flag = hypersiphon_instability_3_1_0
                    }
                    10 = {
                        # one pop dies
                        modifier = {
                            root = { current_stage >= giga_situation_hypersiphon_instability_stage_3 }
                            multiply = 1.5
                        }
                        set_planet_flag = hypersiphon_instability_3_1_1
                    }
                    10 = {
                        # two pops die
                        modifier = {
                            root = { current_stage >= giga_situation_hypersiphon_instability_stage_3 }
                            multiply = 1.5
                        }
                        modifier = {
                            root = { current_stage >= giga_situation_hypersiphon_instability_stage_4 }
                            multiply = 3
                        }
                        set_planet_flag = hypersiphon_instability_3_1_2
                    }
                    2 = {
                        # three pops die
                        modifier = {
                            root = { current_stage >= giga_situation_hypersiphon_instability_stage_3 }
                            multiply = 1.5
                        }
                        modifier = {
                            root = { current_stage >= giga_situation_hypersiphon_instability_stage_4 }
                            multiply = 5
                        }
                        set_planet_flag = hypersiphon_instability_3_1_3
                    }
                }

                # roll 2: debuff
                random_list = {
                    1 = {
                        # energy
                        modifier = {
                            has_generator_designation = yes
                            multiply = 3
                        }
                        modifier = {
                            planet_resource_compare = {
                                type = produces
                                resource = energy
                                value >= 100
                            }
                            multiply = 3
                        }
                        modifier = {
                            has_modifier = giga_hypersiphon_instability_resources_energy
                            multiply = 0
                        }
                        set_planet_flag = hypersiphon_instability_3_2_energy
                    }
                    1 = {
                        # minerals
                        modifier = {
                            has_mining_designation = yes
                            multiply = 3
                        }
                        modifier = {
                            planet_resource_compare = {
                                type = produces
                                resource = minerals
                                value >= 100
                            }
                            multiply = 3
                        }
                        modifier = {
                            has_modifier = giga_hypersiphon_instability_resources_minerals
                            multiply = 0
                        }
                        set_planet_flag = hypersiphon_instability_3_2_minerals
                    }
                    1 = {
                        # food
                        modifier = {
                            has_farming_designation = yes
                            multiply = 3
                        }
                        modifier = {
                            planet_resource_compare = {
                                type = produces
                                resource = food
                                value >= 100
                            }
                            multiply = 3
                        }
                        modifier = {
                            has_modifier = giga_hypersiphon_instability_resources_food
                            multiply = 0
                        }
                        modifier = {
                            owner = { country_uses_food = no }
                            multiply = 0
                        }
                        set_planet_flag = hypersiphon_instability_3_2_food
                    }
                    1 = {
                        # alloys
                        modifier = {
                            has_foundry_designation = yes
                            multiply = 3
                        }
                        modifier = {
                            planet_resource_compare = {
                                type = produces
                                resource = alloys
                                value >= 100
                            }
                            multiply = 3
                        }
                        modifier = {
                            has_modifier = giga_hypersiphon_instability_resources_alloys
                            multiply = 0
                        }
                        set_planet_flag = hypersiphon_instability_3_2_alloys
                    }
                    1 = {
                        # CGs
                        modifier = {
                            has_factory_designation = yes
                            multiply = 3
                        }
                        modifier = {
                            planet_resource_compare = {
                                type = produces
                                resource = consumer_goods
                                value >= 100
                            }
                            multiply = 3
                        }
                        modifier = {
                            has_modifier = giga_hypersiphon_instability_resources_consumer_goods
                            multiply = 0
                        }
                        modifier = {
                            owner = { country_uses_consumer_goods = no }
                            multiply = 0
                        }
                        set_planet_flag = hypersiphon_instability_3_2_consumer_goods
                    }
                    1 = {
                        # unity
                        modifier = {
                            has_unity_designation = yes
                            multiply = 3
                        }
                        modifier = {
                            planet_resource_compare = {
                                type = produces
                                resource = unity
                                value >= 100
                            }
                            multiply = 3
                        }
                        modifier = {
                            has_modifier = giga_hypersiphon_instability_resources_unity
                            multiply = 0
                        }
                        set_planet_flag = hypersiphon_instability_3_2_unity
                    }
                    1 = {
                        # research
                        modifier = {
                            has_research_designation = yes
                            multiply = 3
                        }
                        modifier = {
                            or = {
                                planet_resource_compare = {
                                    type = produces
                                    resource = physics_research
                                    value >= 100
                                }
                                planet_resource_compare = {
                                    type = produces
                                    resource = society_research
                                    value >= 100
                                }
                                planet_resource_compare = {
                                    type = produces
                                    resource = engineering_research
                                    value >= 100
                                }
                            }
                            multiply = 3
                        }
                        modifier = {
                            has_modifier = giga_hypersiphon_instability_resources_research
                            multiply = 0
                        }
                        set_planet_flag = hypersiphon_instability_3_2_research
                    }
                }
            }
        }
    }

    option = {
        name = giga_hypersiphon.030.a

        event_target:hypersiphon_target = {
            # pop deaths
            switch = {
                trigger = has_planet_flag
                # hypersiphon_instability_3_1_0 (nothing happens)
                hypersiphon_instability_3_1_1 = {
                    custom_tooltip = giga_hypersiphon.030.result.1.1
                    add_planet_devastation = 20
                    random_owned_pop = { kill_pop = yes }
                    remove_planet_flag = hypersiphon_instability_3_1_1
                }
                hypersiphon_instability_3_1_2 = {
                    custom_tooltip = giga_hypersiphon.030.result.1.2
                    add_planet_devastation = 40
                    random_owned_pop = { kill_pop = yes }
                    random_owned_pop = { kill_pop = yes }
                    remove_planet_flag = hypersiphon_instability_3_1_2
                }
                hypersiphon_instability_3_1_3 = {
                    custom_tooltip = giga_hypersiphon.030.result.1.3
                    add_planet_devastation = 60
                    random_owned_pop = { kill_pop = yes }
                    random_owned_pop = { kill_pop = yes }
                    random_owned_pop = { kill_pop = yes }
                    remove_planet_flag = hypersiphon_instability_3_1_3
                }
            }

            # debuff
            switch = {
                trigger = has_planet_flag
                # hypersiphon_instability_3_1_0 (nothing happens)
                hypersiphon_instability_3_2_energy = {
                    add_modifier = { modifier = giga_hypersiphon_instability_resources_energy days = @debuff_days }
                    remove_planet_flag = hypersiphon_instability_3_2_energy
                }
                hypersiphon_instability_3_2_minerals = {
                    add_modifier = { modifier = giga_hypersiphon_instability_resources_minerals days = @debuff_days }
                    remove_planet_flag = hypersiphon_instability_3_2_minerals
                }
                hypersiphon_instability_3_2_food = {
                    add_modifier = { modifier = giga_hypersiphon_instability_resources_food days = @debuff_days }
                    remove_planet_flag = hypersiphon_instability_3_2_food
                }
                hypersiphon_instability_3_2_alloys = {
                    add_modifier = { modifier = giga_hypersiphon_instability_resources_alloys days = @debuff_days }
                    remove_planet_flag = hypersiphon_instability_3_2_alloys
                }
                hypersiphon_instability_3_2_consumer_goods = {
                    add_modifier = { modifier = giga_hypersiphon_instability_resources_consumer_goods days = @debuff_days }
                    remove_planet_flag = hypersiphon_instability_3_2_consumer_goods
                }
                hypersiphon_instability_3_2_unity = {
                    add_modifier = { modifier = giga_hypersiphon_instability_resources_unity days = @debuff_days }
                    remove_planet_flag = hypersiphon_instability_3_2_unity
                }
                hypersiphon_instability_3_2_research = {
                    add_modifier = { modifier = giga_hypersiphon_instability_resources_research days = @debuff_days }
                    remove_planet_flag = hypersiphon_instability_3_2_research
                }
            }
        }
    }
}